<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.7.0">
<title data-rh="true">使用MLflow和Ray训练fastText | Eason&#x27;s Blog</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://eason-projects.github.io/eason-blog/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://eason-projects.github.io/eason-blog/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://eason-projects.github.io/eason-blog/blog/fasttext"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" property="og:title" content="使用MLflow和Ray训练fastText | Eason&#x27;s Blog"><meta data-rh="true" name="description" content="fastText是Facebook研发的一款针对NLP领域的解决方案。"><meta data-rh="true" property="og:description" content="fastText是Facebook研发的一款针对NLP领域的解决方案。"><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2025-02-16T00:00:00.000Z"><meta data-rh="true" property="article:author" content="https://github.com/e10101"><meta data-rh="true" property="article:tag" content="Machine Learning,MLflow,NLP"><link data-rh="true" rel="icon" href="/eason-blog/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://eason-projects.github.io/eason-blog/blog/fasttext"><link data-rh="true" rel="alternate" href="https://eason-projects.github.io/eason-blog/blog/fasttext" hreflang="en"><link data-rh="true" rel="alternate" href="https://eason-projects.github.io/eason-blog/blog/fasttext" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","@id":"https://eason-projects.github.io/eason-blog/blog/fasttext","mainEntityOfPage":"https://eason-projects.github.io/eason-blog/blog/fasttext","url":"https://eason-projects.github.io/eason-blog/blog/fasttext","headline":"使用MLflow和Ray训练fastText","name":"使用MLflow和Ray训练fastText","description":"fastText是Facebook研发的一款针对NLP领域的解决方案。","datePublished":"2025-02-16T00:00:00.000Z","author":{"@type":"Person","name":"Eason G.","description":"Engineer","url":"https://github.com/e10101","image":"https://github.com/e10101.png"},"keywords":[],"isPartOf":{"@type":"Blog","@id":"https://eason-projects.github.io/eason-blog/blog","name":"Blog"}}</script><link rel="alternate" type="application/rss+xml" href="/eason-blog/blog/rss.xml" title="Eason&#39;s Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/eason-blog/blog/atom.xml" title="Eason&#39;s Blog Atom Feed">




<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.24/dist/katex.min.css" integrity="sha384-odtC+0UGzzFL/6PNoE8rX/SPcQDXBJ+uRepguP4QkPCm2LBxH3FA3y+fKSiJ+AmM" crossorigin="anonymous"><link rel="stylesheet" href="/eason-blog/assets/css/styles.f9ada502.css">
<script src="/eason-blog/assets/js/runtime~main.578ad8c9.js" defer="defer"></script>
<script src="/eason-blog/assets/js/main.d8f64d59.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><link rel="preload" as="image" href="/eason-blog/img/logo.svg"><link rel="preload" as="image" href="https://github.com/e10101.png"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fS4T" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/eason-blog/"><div class="navbar__logo"><img src="/eason-blog/img/logo.svg" alt="My Site Logo" class="themedComponent_w7Ff themedComponent--light_XSCE"><img src="/eason-blog/img/logo.svg" alt="My Site Logo" class="themedComponent_w7Ff themedComponent--dark_gYKq"></div><b class="navbar__title text--truncate">Eason&#x27;s Blog</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/eason-blog/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/eason-projects/eason-blog" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_Nqc8"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_NnbA colorModeToggle_axvi"><button class="clean-btn toggleButton_rq91 toggleButtonDisabled_Dyik" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite" aria-pressed="false"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_aGzk"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_vJgQ"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_vFHT"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_UKVq"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_kH9a thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_f0nA margin-bottom--md">All Posts</div><div role="group"><h3 class="yearGroupHeading_aA2e">2025</h3><ul class="sidebarItemList_AquT clean-list"><li class="sidebarItem_E4ZX"><a class="sidebarItemLink_DGJH" href="/eason-blog/blog/gurobi">Gurobi 101</a></li><li class="sidebarItem_E4ZX"><a class="sidebarItemLink_DGJH" href="/eason-blog/blog/ble-beacon">使用Python检测蓝牙信号</a></li><li class="sidebarItem_E4ZX"><a class="sidebarItemLink_DGJH" href="/eason-blog/blog/ml-env-setup">基于Docker的机器学习开发环境</a></li><li class="sidebarItem_E4ZX"><a aria-current="page" class="sidebarItemLink_DGJH sidebarItemLinkActive_sObL" href="/eason-blog/blog/fasttext">使用MLflow和Ray训练fastText</a></li><li class="sidebarItem_E4ZX"><a class="sidebarItemLink_DGJH" href="/eason-blog/blog/mlflow-log-model">MLflow保存与使用模型</a></li><li class="sidebarItem_E4ZX"><a class="sidebarItemLink_DGJH" href="/eason-blog/blog/mlflow-change-db">MLflow使用PostgresSQL</a></li><li class="sidebarItem_E4ZX"><a class="sidebarItemLink_DGJH" href="/eason-blog/blog/mlflow-intro">MLflow使用介绍</a></li><li class="sidebarItem_E4ZX"><a class="sidebarItemLink_DGJH" href="/eason-blog/blog/ray-tune">Ray Tune</a></li></ul></div></nav></aside><main class="col col--7"><article class=""><header><h1 class="title_yncw">使用MLflow和Ray训练fastText</h1><div class="container__VqW margin-vert--md"><time datetime="2025-02-16T00:00:00.000Z">February 16, 2025</time> · <!-- -->18 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--12 authorCol_yACt"><div class="avatar margin-bottom--sm"><a class="avatar__photo-link" href="/eason-blog/blog/authors/eason"><img class="avatar__photo authorImage_iXA_" src="https://github.com/e10101.png" alt="Eason G."></a><div class="avatar__intro authorDetails__gHY"><div class="avatar__name"><a href="/eason-blog/blog/authors/eason"><span class="authorName_Voey">Eason G.</span></a></div><small class="authorTitle_uT6c" title="Engineer">Engineer</small><div class="authorSocials_koDp"><a href="https://github.com/e10101" target="_blank" rel="noopener noreferrer" class="authorSocialLink_trpD" title="GitHub"><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 256 250" preserveAspectRatio="xMidYMid" style="--dark:#000;--light:#fff" class="authorSocialLink_trpD githubSvg_q_ZH"><path d="M128.001 0C57.317 0 0 57.307 0 128.001c0 56.554 36.676 104.535 87.535 121.46 6.397 1.185 8.746-2.777 8.746-6.158 0-3.052-.12-13.135-.174-23.83-35.61 7.742-43.124-15.103-43.124-15.103-5.823-14.795-14.213-18.73-14.213-18.73-11.613-7.944.876-7.78.876-7.78 12.853.902 19.621 13.19 19.621 13.19 11.417 19.568 29.945 13.911 37.249 10.64 1.149-8.272 4.466-13.92 8.127-17.116-28.431-3.236-58.318-14.212-58.318-63.258 0-13.975 5-25.394 13.188-34.358-1.329-3.224-5.71-16.242 1.24-33.874 0 0 10.749-3.44 35.21 13.121 10.21-2.836 21.16-4.258 32.038-4.307 10.878.049 21.837 1.47 32.066 4.307 24.431-16.56 35.165-13.12 35.165-13.12 6.967 17.63 2.584 30.65 1.255 33.873 8.207 8.964 13.173 20.383 13.173 34.358 0 49.163-29.944 59.988-58.447 63.157 4.591 3.972 8.682 11.762 8.682 23.704 0 17.126-.148 30.91-.148 35.126 0 3.407 2.304 7.398 8.792 6.14C219.37 232.5 256 184.537 256 128.002 256 57.307 198.691 0 128.001 0Zm-80.06 182.34c-.282.636-1.283.827-2.194.39-.929-.417-1.45-1.284-1.15-1.922.276-.655 1.279-.838 2.205-.399.93.418 1.46 1.293 1.139 1.931Zm6.296 5.618c-.61.566-1.804.303-2.614-.591-.837-.892-.994-2.086-.375-2.66.63-.566 1.787-.301 2.626.591.838.903 1 2.088.363 2.66Zm4.32 7.188c-.785.545-2.067.034-2.86-1.104-.784-1.138-.784-2.503.017-3.05.795-.547 2.058-.055 2.861 1.075.782 1.157.782 2.522-.019 3.08Zm7.304 8.325c-.701.774-2.196.566-3.29-.49-1.119-1.032-1.43-2.496-.726-3.27.71-.776 2.213-.558 3.315.49 1.11 1.03 1.45 2.505.701 3.27Zm9.442 2.81c-.31 1.003-1.75 1.459-3.199 1.033-1.448-.439-2.395-1.613-2.103-2.626.301-1.01 1.747-1.484 3.207-1.028 1.446.436 2.396 1.602 2.095 2.622Zm10.744 1.193c.036 1.055-1.193 1.93-2.715 1.95-1.53.034-2.769-.82-2.786-1.86 0-1.065 1.202-1.932 2.733-1.958 1.522-.03 2.768.818 2.768 1.868Zm10.555-.405c.182 1.03-.875 2.088-2.387 2.37-1.485.271-2.861-.365-3.05-1.386-.184-1.056.893-2.114 2.376-2.387 1.514-.263 2.868.356 3.061 1.403Z"></path></svg></a></div></div></div></div></div></header><div id="__blog-post-container" class="markdown"><p>fastText是Facebook研发的一款针对NLP领域的解决方案。</p>
<p>其主要提供了文本分类和词向量学习两大功能。
其核心思想是将整句话的词向量叠加平均作为文本表示，
并使用softmax分类器进行分类。</p>
<p>我们通过本文介绍一下如何使用MLflow以及Ray来训练我们的fastText模型。</p>
<h2 class="anchor anchorWithStickyNavbar_W39x" id="fasttext介绍">fastText介绍<a href="#fasttext介绍" class="hash-link" aria-label="Direct link to fastText介绍" title="Direct link to fastText介绍">​</a></h2>
<p>fastText作为一个高效的文本分类和词向量表示工具，fastText具有以下特点：</p>
<ol>
<li><strong>训练速度快</strong>：能够在普通多核CPU上几秒内处理数十亿个词，训练数百万个文本分类器</li>
<li><strong>效果优异</strong>：在文本分类任务中取得与深度学习模型相当的精度</li>
<li><strong>资源占用少</strong>：相比深度学习模型，fastText对硬件要求低，且模型文件小</li>
<li><strong>多语言支持</strong>：支持294种语言的词向量训练</li>
</ol>
<h2 class="anchor anchorWithStickyNavbar_W39x" id="训练目标">训练目标<a href="#训练目标" class="hash-link" aria-label="Direct link to 训练目标" title="Direct link to 训练目标">​</a></h2>
<p>在本文中，我们会针对<a href="https://github.com/cooelf/DeepUtteranceAggregation/" target="_blank" rel="noopener noreferrer">淘宝客服对话数据</a>
这个数据集进行处理，我们希望可以训练一个分类器，
来对任意对话文本区分是客户还是客服的消息。</p>
<h2 class="anchor anchorWithStickyNavbar_W39x" id="数据准备">数据准备<a href="#数据准备" class="hash-link" aria-label="Direct link to 数据准备" title="Direct link to 数据准备">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_W39x" id="数据文件格式">数据文件格式<a href="#数据文件格式" class="hash-link" aria-label="Direct link to 数据文件格式" title="Direct link to 数据文件格式">​</a></h3>
<p>我们通过上面的网址下载后，可以看到有3个数据文件，分别是 <code>train.txt</code>、 <code>dev.txt</code>以及<code>test.txt</code>。</p>
<p>打开任意的文件，其内部数据如下：</p>
<div class="language-plaintext codeBlockContainer_gA8_ theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_sPiI"><pre tabindex="0" class="prism-code language-plaintext codeBlock_WGcI thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_UUMe"><span class="token-line" style="color:#393A34"><span class="token plain">1 在 吗 您好 现在 拍 几天 能 到 辽宁 这个 不 一定 哦 大概 几天 不 知道 么 一般 情况 下 3 到 5 天 左右</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0 在 吗 您好 现在 拍 几天 能 到 辽宁 这个 不 一定 哦 大概 几天 不 知道 么 亲 不会 的 呢 您 放心</span><br></span></code></pre><div class="buttonGroup_m2GY"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_AAa7" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_mgjV"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_pZQF"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>每一行表示为：</p>
<ul>
<li><code>1</code>或<code>0</code>：正确的对话流程以及错误的对话流程。</li>
<li>循环（用<code>\t</code>来隔开）：<!-- -->
<ul>
<li>客户问题</li>
<li>客服回答</li>
</ul>
</li>
</ul>
<p>比如上面的数据样本的第一行：</p>
<div class="codeBlockContainer_gA8_ theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_sPiI"><pre tabindex="0" class="prism-code language-text codeBlock_WGcI thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_UUMe"><span class="token-line" style="color:#393A34"><span class="token plain">1 --&gt; 正确的对话</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">在 吗 --&gt; 客户问题</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">您好 --&gt; 客服回答</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">现在 拍 几天 能 到 辽宁 这个 不 一定 哦 大概 几天 不 知道 么 --&gt; 客户问题</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">一般 情况 下 3 到 5 天 左右 --&gt; 客服回答</span><br></span></code></pre><div class="buttonGroup_m2GY"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_AAa7" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_mgjV"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_pZQF"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_W39x" id="fasttext要求的数据格式">fastText要求的数据格式<a href="#fasttext要求的数据格式" class="hash-link" aria-label="Direct link to fastText要求的数据格式" title="Direct link to fastText要求的数据格式">​</a></h3>
<p>fastText有自己独立的数据格式，其输入为文本文件，其每一行的数据格式为：</p>
<div class="codeBlockContainer_gA8_ theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_sPiI"><pre tabindex="0" class="prism-code language-text codeBlock_WGcI thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_UUMe"><span class="token-line" style="color:#393A34"><span class="token plain">分类1 分类2 分类... 文本行</span><br></span></code></pre><div class="buttonGroup_m2GY"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_AAa7" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_mgjV"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_pZQF"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>即，每一行可以关联多个分类，然后分类信息以及文本行信息以空格隔开。</p>
<p>其分类表示有独特的要求，比如我们希望构建两个分类：</p>
<ul>
<li><code>seller</code>：客服</li>
<li><code>customer</code>：客户</li>
</ul>
<p>那么其fastText表示为： <code>__label__customer</code>和<code>__label__seller</code>。</p>
<p>因此，我们需要将上述的原始数据文件，每行进行解析，并按照存储如下的格式的文件，如：</p>
<div class="codeBlockContainer_gA8_ theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_sPiI"><pre tabindex="0" class="prism-code language-text codeBlock_WGcI thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_UUMe"><span class="token-line" style="color:#393A34"><span class="token plain">__label__customer 您好咱们这边如果能提升您的销量利润您会考虑跟我们合作吗</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">__label__customer 亲你家什么时候还有活动啊</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">__label__customer 我的订单怎么两天了没什么变化啊在么</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">__label__customer 好麻烦你改下谢谢</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">__label__customer 明天可以发货</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">__label__seller 有的哦满68送95g猪肉脯一袋</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">__label__customer 这个买两个有优惠吗</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">__label__customer 亲亲已下单买这么多请掌柜的多送点小礼物啊</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">__label__customer 嗯嗯了解了哦</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">__label__customer 我买10个付款的时候怎么不打折呢</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">__label__seller 您这边提交订单看看哦系统自动改价的和芒果干一样的</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">__label__seller 不好意思亲可能快递途中挤压造成的这边退亲2元差价亲看可以吗</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">__label__customer 亲有原味瓜子么</span><br></span></code></pre><div class="buttonGroup_m2GY"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_AAa7" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_mgjV"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_pZQF"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_W39x" id="处理代码">处理代码<a href="#处理代码" class="hash-link" aria-label="Direct link to 处理代码" title="Direct link to 处理代码">​</a></h3>
<p>我们可以构建下面的两个函数，来读取原始的数据文件，然后逐行按照上面的格式，构建一个包含了客户和客服的数据文件。
并按照fastText的格式，保存成训练或者验证文件。</p>
<div class="language-python codeBlockContainer_gA8_ theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_sPiI"><pre tabindex="0" class="prism-code language-python codeBlock_WGcI thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_UUMe"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">load_data</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">path</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">with</span><span class="token plain"> </span><span class="token builtin">open</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">path</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;r&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> f</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        data </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> f</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">readlines</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    customer_utterances </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    seller_utterances </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> idx</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> line </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> tqdm</span><span class="token punctuation" style="color:#393A34">(</span><span class="token builtin">enumerate</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">data</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        utterances </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> line</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">strip</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">split</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;\t&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        utterances </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">re</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sub</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">r&#x27;[\s\n\t]&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> utterance</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> utterance </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> utterances</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> utterances</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;1&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            customer_utterances </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> utterances</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            seller_utterances </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> utterances</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># Remove utterances only contain digits. If it contains digits and other characters, keep it.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    customer_utterances </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">utterance </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> utterance </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> customer_utterances </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">not</span><span class="token plain"> re</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">match</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">r&#x27;^[0-9]+$&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> utterance</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    seller_utterances </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">utterance </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> utterance </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> seller_utterances </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">not</span><span class="token plain"> re</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">match</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">r&#x27;^[0-9]+$&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> utterance</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># Only keep utterances with more than 5 characters</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    customer_utterances </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">utterance </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> utterance </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> customer_utterances </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token builtin">len</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">utterance</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    seller_utterances </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">utterance </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> utterance </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> seller_utterances </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token builtin">len</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">utterance</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># If the utterance are the same in both customer and seller, remove duplicates using sets</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    customer_set </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token builtin">set</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">customer_utterances</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    seller_set </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token builtin">set</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">seller_utterances</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># Remove duplicates that appear in both sets</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    unique_customer </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token builtin">list</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">customer_set </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> seller_set</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    unique_seller </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token builtin">list</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">seller_set </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> customer_set</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> unique_customer</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> unique_seller</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">generate_fasttext_data</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">customer_utterances</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> seller_utterances</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> output_path</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token triple-quoted-string string" style="color:#e3116c">&quot;&quot;&quot;Generate FastText training data with labels.&quot;&quot;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">with</span><span class="token plain"> </span><span class="token builtin">open</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">output_path</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;w&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> encoding</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;utf-8&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> f</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># Write customer utterances</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> utterance </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> customer_utterances</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            f</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">write</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-interpolation string" style="color:#e3116c">f&quot;__label__customer </span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">utterance</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">\n&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># Write seller utterances</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> utterance </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> seller_utterances</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            f</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">write</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-interpolation string" style="color:#e3116c">f&quot;__label__seller </span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">utterance</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">\n&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-interpolation string" style="color:#e3116c">f&quot;FastText training data saved to </span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">output_path</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-interpolation string" style="color:#e3116c">f&quot;Total samples: </span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation builtin">len</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">(</span><span class="token string-interpolation interpolation">customer_utterances</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">)</span><span class="token string-interpolation interpolation"> </span><span class="token string-interpolation interpolation operator" style="color:#393A34">+</span><span class="token string-interpolation interpolation"> </span><span class="token string-interpolation interpolation builtin">len</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">(</span><span class="token string-interpolation interpolation">seller_utterances</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">)</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-interpolation string" style="color:#e3116c">f&quot;Customer samples: </span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation builtin">len</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">(</span><span class="token string-interpolation interpolation">customer_utterances</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">)</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-interpolation string" style="color:#e3116c">f&quot;Seller samples: </span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation builtin">len</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">(</span><span class="token string-interpolation interpolation">seller_utterances</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">)</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">&quot;</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup_m2GY"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_AAa7" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_mgjV"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_pZQF"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>文件处理后，共有训练数据238,275条，其中客户对话138,429条，客服对话99,846条。</p>
<h2 class="anchor anchorWithStickyNavbar_W39x" id="训练">训练<a href="#训练" class="hash-link" aria-label="Direct link to 训练" title="Direct link to 训练">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_W39x" id="fasttext训练">fastText训练<a href="#fasttext训练" class="hash-link" aria-label="Direct link to fastText训练" title="Direct link to fastText训练">​</a></h3>
<p>我们可以通过<code>fasttext.train_supervised()</code>函数来训练我们的模型。比如，使用如下的内容进行训练：</p>
<div class="language-python codeBlockContainer_gA8_ theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_sPiI"><pre tabindex="0" class="prism-code language-python codeBlock_WGcI thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_UUMe"><span class="token-line" style="color:#393A34"><span class="token plain">model </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> fasttext</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">train_supervised</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token builtin">input</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">input_path</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    epoch</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">100</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    lr</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0.1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    wordNgrams</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    verbose</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">model</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">save_model</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">output_path</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup_m2GY"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_AAa7" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_mgjV"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_pZQF"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>其中<code>input_path</code>就是我们上面整理好的数据文件。其他的参数，我们可以选择通过Ray Tune来帮我们进行寻找。</p>
<h3 class="anchor anchorWithStickyNavbar_W39x" id="ray-tune寻找参数">Ray Tune寻找参数<a href="#ray-tune寻找参数" class="hash-link" aria-label="Direct link to Ray Tune寻找参数" title="Direct link to Ray Tune寻找参数">​</a></h3>
<p>为了使用Ray Tune，我们需要定义一个训练的步骤，其接收训练的超参数配置，通过制定训练文件，以及测试文件。
代码如下：</p>
<div class="language-python codeBlockContainer_gA8_ theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_sPiI"><pre tabindex="0" class="prism-code language-python codeBlock_WGcI thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_UUMe"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">get_file_size_mb</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">file_path</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token triple-quoted-string string" style="color:#e3116c">&quot;&quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    Get file size in megabytes.</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    Args:</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">        file_path (str): Path to the file</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">        </span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    Returns:</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">        float: File size in MB</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    &quot;&quot;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    size_bytes </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> os</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">path</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">getsize</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">file_path</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    size_mb </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> size_bytes </span><span class="token operator" style="color:#393A34">/</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1024</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1024</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token builtin">round</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">size_mb</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">train_and_evaluate_model</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">config</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> input_path</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> test_path</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mlflow</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">set_tracking_uri</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">MLFLOW_TRACKING_URI</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mlflow</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">set_experiment</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;fasttext-demo-v3&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    context </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ray</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">train</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get_context</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    trial_id </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get_trial_id</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">with</span><span class="token plain"> mlflow</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">start_run</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">run_name</span><span class="token operator" style="color:#393A34">=</span><span class="token string-interpolation string" style="color:#e3116c">f&#x27;trial_</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">trial_id</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> run</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        model_path </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string-interpolation string" style="color:#e3116c">f&#x27;model_trail_</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">trial_id</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">.bin&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        training_df </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> convert_file_into_dataframe</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">input_path</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">input_path</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        dataset </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> mlflow</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">data</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">from_pandas</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            training_df</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> name</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;traing data&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> targets</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;label&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        mlflow</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">log_input</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">dataset</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">dataset</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> context</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;training&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        mlflow</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">log_params</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">config</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># Use the dictionary&#x27;s attributes in the function call</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        model </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> fasttext</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">train_supervised</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">**</span><span class="token plain">config</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        model</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">save_model</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">model_path</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        model_size_mb </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> get_file_size_mb</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">model_path</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        num_of_samples</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> precision</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> recall </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> model</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">test</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">test_path</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        f1_score </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> precision </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> recall </span><span class="token operator" style="color:#393A34">/</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">precision </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> recall</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        mlflow</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">log_metrics</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token string" style="color:#e3116c">&quot;f1_score&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> f1_score</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token string" style="color:#e3116c">&quot;precision&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> precision</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token string" style="color:#e3116c">&quot;recall&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> recall</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token string" style="color:#e3116c">&quot;model_size&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> model</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get_output_matrix</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">size</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token string" style="color:#e3116c">&quot;model_size_mb&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> model_size_mb</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        tune</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">report</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token string" style="color:#e3116c">&quot;f1_score&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> f1_score</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token string" style="color:#e3116c">&quot;precision&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> precision</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token string" style="color:#e3116c">&quot;recall&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> recall</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token string" style="color:#e3116c">&quot;model_size&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> model</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get_output_matrix</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">size</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token string" style="color:#e3116c">&quot;model_size_mb&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> model_size_mb</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token string" style="color:#e3116c">&quot;model_path&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> model_path</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup_m2GY"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_AAa7" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_mgjV"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_pZQF"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>函数<code>train_and_evaluate_model</code>是我们用来训练和评估fastText模型的核心函数，它结合了MLflow和Ray Tune的功能。详细解析如下：</p>
<ol>
<li>
<p><strong>函数参数</strong>：</p>
<ul>
<li><code>config</code>：包含模型训练参数的字典</li>
<li><code>input_path</code>：训练数据文件的路径</li>
<li><code>test_path</code>：测试数据文件的路径</li>
</ul>
</li>
<li>
<p><strong>MLflow设置</strong>：</p>
<div class="language-python codeBlockContainer_gA8_ theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_sPiI"><pre tabindex="0" class="prism-code language-python codeBlock_WGcI thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_UUMe"><span class="token-line" style="color:#393A34"><span class="token plain">mlflow</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">set_tracking_uri</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">MLFLOW_TRACKING_URI</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mlflow</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">set_experiment</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;fasttext-demo-v3&quot;</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup_m2GY"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_AAa7" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_mgjV"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_pZQF"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>设置MLflow的追踪服务器地址并创建名为<code>fasttext-demo-v3</code>的实验。</p>
</li>
<li>
<p><strong>Ray Tune上下文</strong>：</p>
<div class="language-python codeBlockContainer_gA8_ theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_sPiI"><pre tabindex="0" class="prism-code language-python codeBlock_WGcI thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_UUMe"><span class="token-line" style="color:#393A34"><span class="token plain">context </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ray</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">train</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get_context</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">trial_id </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get_trial_id</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup_m2GY"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_AAa7" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_mgjV"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_pZQF"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>获取Ray Tune的训练上下文和试验ID，用于区分不同的训练试验。其格式为8位16进制的字符串，例如：<code>01b8b86e</code>。</p>
</li>
<li>
<p><strong>数据准备</strong>：</p>
<div class="language-python codeBlockContainer_gA8_ theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_sPiI"><pre tabindex="0" class="prism-code language-python codeBlock_WGcI thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_UUMe"><span class="token-line" style="color:#393A34"><span class="token plain">training_df </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> convert_file_into_dataframe</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">input_path</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">input_path</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">dataset </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> mlflow</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">data</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">from_pandas</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">training_df</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> name</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;traing data&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> targets</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;label&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mlflow</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">log_input</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">dataset</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">dataset</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> context</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;training&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup_m2GY"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_AAa7" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_mgjV"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_pZQF"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>将训练数据转换为DataFrame，并创建MLflow数据集对象。
此步骤非必须，主要是为了演示如何使用MLflow的<code>mlflow.log_input</code>来保存训练的数据。</p>
</li>
<li>
<p><strong>模型训练</strong>：</p>
<div class="language-python codeBlockContainer_gA8_ theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_sPiI"><pre tabindex="0" class="prism-code language-python codeBlock_WGcI thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_UUMe"><span class="token-line" style="color:#393A34"><span class="token plain">model </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> fasttext</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">train_supervised</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">**</span><span class="token plain">config</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">model</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">save_model</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">model_path</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup_m2GY"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_AAa7" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_mgjV"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_pZQF"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>使用配置参数训练fastText模型，并保存模型文件。</p>
</li>
<li>
<p><strong>模型评估</strong>：</p>
<div class="language-python codeBlockContainer_gA8_ theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_sPiI"><pre tabindex="0" class="prism-code language-python codeBlock_WGcI thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_UUMe"><span class="token-line" style="color:#393A34"><span class="token plain">model_size_mb </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> get_file_size_mb</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">model_path</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">num_of_samples</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> precision</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> recall </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> model</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">test</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">test_path</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">f1_score </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> precision </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> recall </span><span class="token operator" style="color:#393A34">/</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">precision </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> recall</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup_m2GY"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_AAa7" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_mgjV"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_pZQF"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>使用测试数据评估模型性能，计算精确率、召回率和F1分数。
同时我们也通过函数<code>get_file_size_mb</code>来计算生成模型文件的大小，
主要是考虑既满足模型的准确率等要求，同时，也要比较小的计算性能消耗。</p>
</li>
<li>
<p><strong>指标记录</strong>：</p>
<ul>
<li>
<p>使用MLflow记录参数和指标：</p>
<div class="language-python codeBlockContainer_gA8_ theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_sPiI"><pre tabindex="0" class="prism-code language-python codeBlock_WGcI thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_UUMe"><span class="token-line" style="color:#393A34"><span class="token plain">mlflow</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">log_params</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">config</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mlflow</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">log_metrics</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup_m2GY"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_AAa7" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_mgjV"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_pZQF"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
<li>
<p>向Ray Tune报告结果：</p>
<div class="language-python codeBlockContainer_gA8_ theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_sPiI"><pre tabindex="0" class="prism-code language-python codeBlock_WGcI thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_UUMe"><span class="token-line" style="color:#393A34"><span class="token plain">tune</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">report</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup_m2GY"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_AAa7" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_mgjV"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_pZQF"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
</ul>
<p>记录训练参数、评估指标和模型大小等信息。</p>
</li>
</ol>
<p>函数<code>train_and_evaluate_model</code>通过MLflow追踪每次训练的过程和结果，同时通过Ray Tune进行超参数优化。每次训练都会：</p>
<ul>
<li>记录训练参数</li>
<li>保存训练数据信息</li>
<li>训练模型</li>
<li>评估模型性能</li>
<li>记录各种指标</li>
</ul>
<p>这样我们就可以通过MLflow的UI界面查看每次训练的详细信息，并通过Ray Tune找到最优的模型参数配置。</p>
<div class="theme-admonition theme-admonition-tip admonition_YDlw alert alert--success"><div class="admonitionHeading_sm1J"><span class="admonitionIcon_Is09"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>训练文件路径</div><div class="admonitionContent_cRly"><p>我们在使用Ray Tune进行训练的时候，需要注意Ray是一个分布式的训练引擎，
因此它有可能会在不同的主机上运行训练代码。</p><p>所以，我们需要确保训练的数据，在不同的主机上都可以被访问。</p><p>本文中，我们使用的是本地单机的Ray，所以我们使用了绝对路径来提供训练文件，如：
<code>/ray-tune/data/fasttext_train.txt</code>。</p></div></div>
<h3 class="anchor anchorWithStickyNavbar_W39x" id="定义参数寻找范围">定义参数寻找范围<a href="#定义参数寻找范围" class="hash-link" aria-label="Direct link to 定义参数寻找范围" title="Direct link to 定义参数寻找范围">​</a></h3>
<p>我们有了上面的训练函数后，就可以通过定义Ray的参数范围，以及优化策略来训练我们的模型了。</p>
<div class="language-python codeBlockContainer_gA8_ theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_sPiI"><pre tabindex="0" class="prism-code language-python codeBlock_WGcI thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_UUMe"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">tune_fasttext_parameters</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">input_path</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> test_path</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> num_samples</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">50</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ray</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">init</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    config </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;input&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> input_path</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;epoch&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> tune</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">randint</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">50</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">300</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;lr&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> tune</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">loguniform</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1e-5</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1e-3</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># Reduced max learning rate</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;wordNgrams&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> tune</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">randint</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">4</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;dim&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> tune</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">randint</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">10</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">50</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;ws&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> tune</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">randint</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">7</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;minCount&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> tune</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">randint</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;minn&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;maxn&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;bucket&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> tune</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">choice</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">50000</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">100000</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">200000</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;thread&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">4</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;loss&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;softmax&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;verbose&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    search_algo </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> OptunaSearch</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        metric</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;f1_score&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;model_size_mb&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        mode</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;max&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;min&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    analysis </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> tune</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">run</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">lambda</span><span class="token plain"> trail_config</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> train_and_evaluate_model</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">trail_config</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> input_path</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> test_path</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        config</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">config</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        num_samples</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">num_samples</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        search_alg</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">search_algo</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        resources_per_trial</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">{</span><span class="token string" style="color:#e3116c">&quot;cpu&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">4</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># Get the best trial based on both metrics</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    best_trial </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> analysis</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get_best_trial</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        metric</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;f1_score&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># Primary metric</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        mode</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;max&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        scope</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;last&quot;</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># Consider only the last reported results</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-interpolation string" style="color:#e3116c">f&quot;Best trial: </span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">best_trial</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> best_trial</span><br></span></code></pre><div class="buttonGroup_m2GY"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_AAa7" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_mgjV"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_pZQF"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>函数<code>tune_fasttext_parameters</code>是用来配置和执行Ray Tune超参数优化的主要函数。其详细设置如下：</p>
<ol>
<li>
<p><strong>函数参数</strong>：</p>
<ul>
<li><code>input_path</code>：训练数据文件的路径</li>
<li><code>test_path</code>：测试数据文件的路径</li>
<li><code>num_samples</code>：超参数搜索的试验次数，默认为50次</li>
</ul>
</li>
<li>
<p><strong>Ray初始化</strong>：</p>
<div class="language-python codeBlockContainer_gA8_ theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_sPiI"><pre tabindex="0" class="prism-code language-python codeBlock_WGcI thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_UUMe"><span class="token-line" style="color:#393A34"><span class="token plain">ray</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">init</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup_m2GY"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_AAa7" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_mgjV"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_pZQF"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>初始化Ray运行时环境，为分布式训练做准备。</p>
</li>
<li>
<p><strong>超参数配置空间</strong>：</p>
<div class="language-python codeBlockContainer_gA8_ theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_sPiI"><pre tabindex="0" class="prism-code language-python codeBlock_WGcI thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_UUMe"><span class="token-line" style="color:#393A34"><span class="token plain">config </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;input&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> input_path</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;epoch&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> tune</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">randint</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">50</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">300</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;lr&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> tune</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">loguniform</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1e-5</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1e-3</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;wordNgrams&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> tune</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">randint</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">4</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup_m2GY"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_AAa7" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_mgjV"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_pZQF"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>定义了fastText模型的各个超参数的搜索空间：</p>
<ul>
<li><code>epoch</code>：训练轮数，在50到300之间随机选择。</li>
<li><code>lr</code>：学习率，在1e-5到1e-3之间按对数均匀分布选择。</li>
<li><code>wordNgrams</code>：词组长度，在1到4之间选择。</li>
<li><code>dim</code>：词向量维度，在10到50之间选择。</li>
<li><code>ws</code>：上下文窗口大小，在3到7之间选择。</li>
<li><code>minCount</code>：最小词频，在2到10之间选择。</li>
<li><code>bucket</code>：哈希桶数量，在[50000, 100000, 200000]中选择，其数值较小可减少模型大小，但是容易产生冲突并损失特征信息。</li>
</ul>
</li>
<li>
<p><strong>搜索算法配置</strong>：</p>
<div class="language-python codeBlockContainer_gA8_ theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_sPiI"><pre tabindex="0" class="prism-code language-python codeBlock_WGcI thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_UUMe"><span class="token-line" style="color:#393A34"><span class="token plain">search_algo </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> OptunaSearch</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    metric</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;f1_score&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;model_size_mb&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mode</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;max&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;min&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup_m2GY"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_AAa7" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_mgjV"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_pZQF"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>使用Optuna作为搜索算法，优化两个目标：</p>
<ul>
<li>最大化F1分数</li>
<li>最小化模型大小</li>
</ul>
</li>
<li>
<p><strong>执行超参数搜索</strong>：</p>
<div class="language-python codeBlockContainer_gA8_ theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_sPiI"><pre tabindex="0" class="prism-code language-python codeBlock_WGcI thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_UUMe"><span class="token-line" style="color:#393A34"><span class="token plain">analysis </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> tune</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">run</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">lambda</span><span class="token plain"> trail_config</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> train_and_evaluate_model</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">trail_config</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> input_path</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> test_path</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    config</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">config</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    num_samples</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">num_samples</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    search_alg</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">search_algo</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    resources_per_trial</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">{</span><span class="token string" style="color:#e3116c">&quot;cpu&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">4</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup_m2GY"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_AAa7" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_mgjV"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_pZQF"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>启动超参数搜索：</p>
<ul>
<li>每次试验都会调用<code>train_and_evaluate_model</code>函数</li>
<li>使用配置的参数空间进行搜索</li>
<li>执行指定次数的试验</li>
<li>每个试验分配4个CPU核心</li>
</ul>
</li>
<li>
<p><strong>获取最佳结果</strong>：</p>
<div class="language-python codeBlockContainer_gA8_ theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_sPiI"><pre tabindex="0" class="prism-code language-python codeBlock_WGcI thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_UUMe"><span class="token-line" style="color:#393A34"><span class="token plain">best_trial </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> analysis</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get_best_trial</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    metric</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;f1_score&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mode</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;max&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    scope</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;last&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup_m2GY"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_AAa7" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_mgjV"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_pZQF"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>从所有试验中选择最佳结果：</p>
<ul>
<li>主要基于F1分数进行选择</li>
<li>选择F1分数最高的试验</li>
<li>只考虑每个试验的最后一次结果</li>
</ul>
</li>
</ol>
<p>这个函数通过Ray Tune的超参数优化功能，自动搜索最佳的fastText模型参数配置。它不仅考虑了模型的性能（F1分数），
还考虑了模型的大小，这样可以在性能和资源消耗之间找到一个良好的平衡点。</p>
<div class="theme-admonition theme-admonition-tip admonition_YDlw alert alert--success"><div class="admonitionHeading_sm1J"><span class="admonitionIcon_Is09"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>多目标优化</div><div class="admonitionContent_cRly"><p>在本例中，我们使用了Optuna作为搜索算法，并设置了两个优化目标：F1分数和模型大小。
这种多目标优化可以帮助我们在模型性能和资源消耗之间找到更好的平衡。</p><p>但是在最终选择最佳试验时，我们仍然主要基于F1分数进行选择。这是因为在实际应用中，
我们通常会优先考虑模型的性能，只要模型大小在可接受的范围内即可。</p></div></div>
<h2 class="anchor anchorWithStickyNavbar_W39x" id="可选步骤">可选步骤<a href="#可选步骤" class="hash-link" aria-label="Direct link to 可选步骤" title="Direct link to 可选步骤">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_W39x" id="对训练异常进行处理">对训练异常进行处理<a href="#对训练异常进行处理" class="hash-link" aria-label="Direct link to 对训练异常进行处理" title="Direct link to 对训练异常进行处理">​</a></h3>
<p>由于fastText在训练过程中，可能会报错。因此我们可以针对训练过程中的异常进行捕获，然后进行针对性的处理。</p>
<div class="language-python codeBlockContainer_gA8_ theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_sPiI"><pre tabindex="0" class="prism-code language-python codeBlock_WGcI thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_UUMe"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">train_and_evaluate_model</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">config</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> input_path</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> test_path</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">try</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic"># Use the dictionary&#x27;s attributes in the function call</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            model </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> fasttext</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">train_supervised</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">**</span><span class="token plain">config</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            model</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">save_model</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">model_path</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            model_size_mb </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> get_file_size_mb</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">model_path</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            num_of_samples</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> precision</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> recall </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> model</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">test</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">test_path</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            f1_score </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> precision </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> recall </span><span class="token operator" style="color:#393A34">/</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">precision </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> recall</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            mlflow</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">log_metrics</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token string" style="color:#e3116c">&quot;f1_score&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> f1_score</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token string" style="color:#e3116c">&quot;precision&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> precision</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token string" style="color:#e3116c">&quot;recall&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> recall</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token string" style="color:#e3116c">&quot;model_size&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> model</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get_output_matrix</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">size</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token string" style="color:#e3116c">&quot;model_size_mb&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> model_size_mb</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            tune</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">report</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token string" style="color:#e3116c">&quot;f1_score&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> f1_score</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token string" style="color:#e3116c">&quot;precision&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> precision</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token string" style="color:#e3116c">&quot;recall&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> recall</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token string" style="color:#e3116c">&quot;model_size&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> model</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get_output_matrix</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">size</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token string" style="color:#e3116c">&quot;model_size_mb&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> model_size_mb</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token string" style="color:#e3116c">&quot;model_path&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> model_path</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">except</span><span class="token plain"> Exception </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> e</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-interpolation string" style="color:#e3116c">f&quot;Error: </span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">e</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            mlflow</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">log_param</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;error_message&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token builtin">str</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">e</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            mlflow</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">log_metric</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;failed&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            tune</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">report</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token string" style="color:#e3116c">&quot;f1_score&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token string" style="color:#e3116c">&quot;precision&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token string" style="color:#e3116c">&quot;recall&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token string" style="color:#e3116c">&quot;model_size&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token string" style="color:#e3116c">&quot;model_size_mb&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> sys</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">float_info</span><span class="token punctuation" style="color:#393A34">.</span><span class="token builtin">max</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token string" style="color:#e3116c">&quot;model_path&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> model_path</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># ...</span><br></span></code></pre><div class="buttonGroup_m2GY"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_AAa7" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_mgjV"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_pZQF"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>从上面的代码中，我们添加了<code>try...except</code>语句来处理异常，尤其是在异常后，
我们会记录异常的原因，同时利用<code>tune.report</code>来告知优化器，该参数组合可能会造成异常。
因此，应当尽量规避。</p>
<h3 class="anchor anchorWithStickyNavbar_W39x" id="记录模型">记录模型<a href="#记录模型" class="hash-link" aria-label="Direct link to 记录模型" title="Direct link to 记录模型">​</a></h3>
<p>在训练并验证后，我们希望可以保存模型的模型文件，因此通过构造支持<code>mlflow.pyfunc.log_model</code>的包装器，
我们可以快捷的保存并注册模型文件。例如我们构造的包装器：</p>
<div class="language-python codeBlockContainer_gA8_ theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_sPiI"><pre tabindex="0" class="prism-code language-python codeBlock_WGcI thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_UUMe"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">FastTextWrapper</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">mlflow</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">pyfunc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">PythonModel</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">load_context</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> context</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">model </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> fasttext</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">load_model</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">artifacts</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;fasttext_model&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">predict</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> context</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> model_input</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        predictions </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> text </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> model_input</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;text&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            label</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> prob </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">model</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">predict</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">text</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            predictions</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">append</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token string" style="color:#e3116c">&quot;label&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> label</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;probability&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> prob</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> predictions</span><br></span></code></pre><div class="buttonGroup_m2GY"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_AAa7" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_mgjV"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_pZQF"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>在模型训练后，我们可以及时注册模型文件，如下：</p>
<div class="language-python codeBlockContainer_gA8_ theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_sPiI"><pre tabindex="0" class="prism-code language-python codeBlock_WGcI thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_UUMe"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># Log the model as an artifact</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mlflow</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">log_artifact</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">model_path</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;model&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mlflow</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">pyfunc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">log_model</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    artifact_path</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;fasttext_model&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    python_model</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">FastTextWrapper</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    artifacts</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;fasttext_model&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> model_path</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    registered_model_name</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;fasttext_classifier&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup_m2GY"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_AAa7" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_mgjV"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_pZQF"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>这样，在我们的MLflow系统中，我们就可以查看到某一个运行结果所对应的模型文件信息了。</p>
<p>而且，也方便我们后续使用响应的模型结果用于验证等目的。</p>
<h2 class="anchor anchorWithStickyNavbar_W39x" id="结果解析">结果解析<a href="#结果解析" class="hash-link" aria-label="Direct link to 结果解析" title="Direct link to 结果解析">​</a></h2>
<p>我们打开MLflow的后台，通过检索过滤满足：<code>metrics.model_size_mb &lt; 5</code>条件的记录，我们得到71个运行结果。如下图所示：</p>
<p><img decoding="async" loading="lazy" alt="MLflow Result" src="/eason-blog/assets/images/mlflow-result-2d49c485bc45296c94696af5f66fc7f3.png" width="1918" height="1078" class="img_QRCw"></p>
<p>我们按照<code>model_size_mb</code>进行排序，可以找到最小模型大小的文件，然后我们通过检查<code>f1_score</code>的结果，可以获得相应的训练参数。</p>
<h2 class="anchor anchorWithStickyNavbar_W39x" id="总结">总结<a href="#总结" class="hash-link" aria-label="Direct link to 总结" title="Direct link to 总结">​</a></h2>
<p>在本文中，我们通过使用Ray Tune以及MLflow，实现了针对fastText的训练。</p>
<p>同时借助参数寻找优化策略，我们可以快速的找到让我们满意的参数空间。</p></div><footer class="docusaurus-mt-lg"><div class="row margin-top--sm theme-blog-footer-edit-meta-row"><div class="col"><b>Tags:</b><ul class="tags_Ou9F padding--none margin-left--sm"><li class="tag_qUVX"><a title="Machine Learning related posts" class="tag_N5F5 tagRegular_e7_C" href="/eason-blog/blog/tags/machine-learning">Machine Learning</a></li><li class="tag_qUVX"><a title="MLflow related posts" class="tag_N5F5 tagRegular_e7_C" href="/eason-blog/blog/tags/mlflow">MLflow</a></li><li class="tag_qUVX"><a title="Natural Language Processing (NLP) related posts" class="tag_N5F5 tagRegular_e7_C" href="/eason-blog/blog/tags/nlp">NLP</a></li></ul></div></div><div class="row margin-top--sm theme-blog-footer-edit-meta-row"><div class="col"><a href="https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/blog/2025-02-16-fasttext/index.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_jfoZ" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_hEsU"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/eason-blog/blog/ml-env-setup"><div class="pagination-nav__sublabel">Newer post</div><div class="pagination-nav__label">基于Docker的机器学习开发环境</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/eason-blog/blog/mlflow-log-model"><div class="pagination-nav__sublabel">Older post</div><div class="pagination-nav__label">MLflow保存与使用模型</div></a></nav></main><div class="col col--2"><div class="tableOfContents_HyzE thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#fasttext介绍" class="table-of-contents__link toc-highlight">fastText介绍</a></li><li><a href="#训练目标" class="table-of-contents__link toc-highlight">训练目标</a></li><li><a href="#数据准备" class="table-of-contents__link toc-highlight">数据准备</a><ul><li><a href="#数据文件格式" class="table-of-contents__link toc-highlight">数据文件格式</a></li><li><a href="#fasttext要求的数据格式" class="table-of-contents__link toc-highlight">fastText要求的数据格式</a></li><li><a href="#处理代码" class="table-of-contents__link toc-highlight">处理代码</a></li></ul></li><li><a href="#训练" class="table-of-contents__link toc-highlight">训练</a><ul><li><a href="#fasttext训练" class="table-of-contents__link toc-highlight">fastText训练</a></li><li><a href="#ray-tune寻找参数" class="table-of-contents__link toc-highlight">Ray Tune寻找参数</a></li><li><a href="#定义参数寻找范围" class="table-of-contents__link toc-highlight">定义参数寻找范围</a></li></ul></li><li><a href="#可选步骤" class="table-of-contents__link toc-highlight">可选步骤</a><ul><li><a href="#对训练异常进行处理" class="table-of-contents__link toc-highlight">对训练异常进行处理</a></li><li><a href="#记录模型" class="table-of-contents__link toc-highlight">记录模型</a></li></ul></li><li><a href="#结果解析" class="table-of-contents__link toc-highlight">结果解析</a></li><li><a href="#总结" class="table-of-contents__link toc-highlight">总结</a></li></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2025 Eason's Blog. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>